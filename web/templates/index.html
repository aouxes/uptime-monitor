<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uptime Monitor</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="toast-container"></div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ª–æ–≥–∏–Ω–∞ -->
        <div id="login-page" class="page active">
            <div class="auth-card">
                <h1>Uptime Monitor</h1>
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="Username" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">–í–æ–π—Ç–∏</button>
                </form>
                <p class="auth-switch">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="#" onclick="showPage('register-page')">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a></p>
            </div>
        </div>

        <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="register-page" class="page">
            <div class="auth-card">
                <h1>–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h1>
                <form id="register-form">
                    <input type="text" id="register-username" placeholder="Username" required>
                    <input type="email" id="register-email" placeholder="Email" required>
                    <input type="password" id="register-password" placeholder="Password" required>
                    <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>
                <p class="auth-switch">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="#" onclick="showPage('login-page')">–í–æ–π—Ç–∏</a></p>
            </div>
        </div>

        <!-- –î–∞—à–±–æ—Ä–¥ -->
        <div id="dashboard-page" class="page">
            <header class="header">
                <h1>Uptime Monitor</h1>
                <div class="header-actions">
                    <div class="user-info">
                        <span id="user-name" class="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    </div>
                    <button class="telegram-btn" onclick="showTelegramSettings()">üì± Telegram</button>
                    <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- –§–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                <div class="card">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–∞–π—Ç—ã</h3>
                    <form id="add-site-form">
                        <input type="url" id="site-url" placeholder="https://example.com" required>
                        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </form>
                    
                    <div class="divider">–∏–ª–∏</div>
                    
                    <form id="bulk-add-form">
                        <textarea 
                            id="bulk-sites" 
                            placeholder="–°–ø–∏—Å–æ–∫ URL (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏). –ú–∞–∫—Å–∏–º—É–º 50 —Å–∞–π—Ç–æ–≤ –∑–∞ —Ä–∞–∑."
                            rows="4"
                            required
                        ></textarea>
                        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ</button>
                    </form>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Å–∞–π—Ç–æ–≤ -->
                <div class="card">
                    <h3 class="sites-title">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∞–π—Ç–æ–≤</h3>
                    
                    <div class="sites-controls">
                        <div class="left-controls">
                            <button id="filter-down-btn" class="filter-btn" onclick="toggleDownFilter()">
                                <span class="filter-icon">üîç</span>
                                –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ DOWN
                            </button>
                            <button id="refresh-btn" class="refresh-btn" onclick="refreshSites()">
                                <span class="refresh-icon">üîÑ</span>
                                –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                        
                        <div class="right-controls">
                            <div id="bulk-actions" class="bulk-actions">
                                <span id="selected-count">0</span>
                                <button class="danger-btn" onclick="deleteSelectedSites()">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
                            </div>
                            <div class="select-all">
                                <input type="checkbox" id="select-all-checkbox" onchange="toggleSelectAll(this)">
                                <label for="select-all-checkbox">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="sites-container" class="sites-list"></div>
                </div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram -->
        <div id="telegram-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram</h3>
                    <button class="modal-close" onclick="closeTelegramSettings()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="telegram-status" class="telegram-status">
                        <p>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</p>
                    </div>
                    
                    <div id="telegram-link-section" class="telegram-link-section" style="display: none;">
                        <h4>–°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</h4>
                        <p>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ —Å—Ç–∞—Ç—É—Å–µ —Å–∞–π—Ç–æ–≤:</p>
                        <ol>
                            <li>–ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ <code>@aouxesbot</code> –≤ Telegram</li>
                            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/start</code></li>
                            <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞</li>
                            <li>–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/link –≤–∞—à_–∫–æ–¥</code> –±–æ—Ç—É</li>
                        </ol>
                        
                        <button id="generate-link-btn" class="btn-primary" onclick="generateTelegramLink()">
                            –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
                        </button>
                        
                        <div id="link-code-display" class="link-code-display" style="display: none;">
                            <p><strong>–í–∞—à –∫–æ–¥:</strong></p>
                            <div class="code-box">
                                <code id="link-code"></code>
                                <button class="copy-btn" onclick="copyLinkCode()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                            <p class="code-expires">–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 10 –º–∏–Ω—É—Ç</p>
                        </div>
                    </div>
                    
                    <div id="telegram-unlink-section" class="telegram-unlink-section" style="display: none;">
                        <h4>–ê–∫–∫–∞—É–Ω—Ç —Å–≤—è–∑–∞–Ω</h4>
                        <p>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≤—è–∑–∞–Ω —Å Telegram –±–æ—Ç–æ–º.</p>
                        <button class="btn-danger" onclick="unlinkTelegram()">–û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/toast.js"></script>
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/sites.js"></script>
    <script>
    // currentToken —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω –≤ auth.js
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑ auth.js —É–¥–∞–ª–µ–Ω—ã)
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
        });
        document.getElementById(pageId).classList.add('active');
    }

    // Telegram —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ)
    window.showTelegramSettings = function() {
        console.log('showTelegramSettings called');
        const modal = document.getElementById('telegram-modal');
        console.log('Modal element:', modal);
        modal.style.display = 'flex';
        checkTelegramStatus();
    };

    window.closeTelegramSettings = function() {
        document.getElementById('telegram-modal').style.display = 'none';
    }

    function checkTelegramStatus() {
        console.log('checkTelegramStatus called');
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –¥–ª—è —Å–≤—è–∑—ã–≤–∞–Ω–∏—è
        document.getElementById('telegram-status').style.display = 'none';
        document.getElementById('telegram-link-section').style.display = 'block';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
        const linkSection = document.getElementById('telegram-link-section');
        const generateBtn = document.getElementById('generate-link-btn');
        console.log('Link section:', linkSection);
        console.log('Generate button:', generateBtn);
    }

    async function generateTelegramLink() {
        console.log('generateTelegramLink called');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
        const token = localStorage.getItem('token');
        if (!token) {
            console.error('No token found');
            showToast('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
            return;
        }
        console.log('Token found:', token.substring(0, 20) + '...');
        
        const btn = document.getElementById('generate-link-btn');
        if (!btn) {
            console.error('Generate button not found');
            showToast('–ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
            return;
        }
        
        btn.disabled = true;
        btn.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥...';

        try {
            console.log('Sending request to /api/telegram/link-code');
            console.log('Current token:', token.substring(0, 20) + '...');
            
            const response = await fetch('/api/telegram/link-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            if (response.ok) {
                const data = await response.json();
                console.log('Response data:', data);
                
                const codeElement = document.getElementById('link-code');
                const displayElement = document.getElementById('link-code-display');
                
                console.log('Code element:', codeElement);
                console.log('Display element:', displayElement);
                
                if (codeElement && displayElement) {
                    codeElement.textContent = data.code;
                    displayElement.style.display = 'block';
                    console.log('Code set to:', data.code);
                    console.log('Display element style:', displayElement.style.display);
                    showToast(data.message, 'success');
                } else {
                    console.error('Code elements not found');
                    console.error('Available elements:', document.querySelectorAll('[id*="link"]'));
                    showToast('–≠–ª–µ–º–µ–Ω—Ç—ã –∫–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                }
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                console.error('Response status:', response.status);
                
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    showToast('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ', 'error');
                    showPage('login-page');
                } else {
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞: ' + response.status, 'error');
                }
            }
        } catch (error) {
            console.error('Network error:', error);
            console.error('Error details:', error.message);
            showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message, 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å–≤—è–∑—ã–≤–∞–Ω–∏—è';
        }
    }

    function copyLinkCode() {
        const codeElement = document.getElementById('link-code');
        if (!codeElement) {
            console.error('Code element not found for copying');
            showToast('–≠–ª–µ–º–µ–Ω—Ç –∫–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }
        
        const code = codeElement.textContent;
        const command = `/link ${code}`;
        console.log('Copying command:', command);
        
        navigator.clipboard.writeText(command).then(() => {
            console.log('Command copied successfully');
            showToast('–ö–æ–º–∞–Ω–¥–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
        }).catch((err) => {
            console.error('Failed to copy command:', err);
            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É', 'error');
        });
    }

    function unlinkTelegram() {
        if (confirm('–û—Ç–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç –æ—Ç Telegram? –í—ã –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.')) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –æ—Ç–≤—è–∑—ã–≤–∞–Ω–∏—è
            showToast('–§—É–Ω–∫—Ü–∏—è –æ—Ç–≤—è–∑—ã–≤–∞–Ω–∏—è –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏', 'info');
        }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.getElementById('telegram-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeTelegramSettings();
        }
    });

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–Ω–∞ 30 —Å–µ–∫—É–Ω–¥ –ø–æ–∑–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞)
    let autoRefreshInterval;
    
    function startAutoRefresh() {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (300000 –º—Å)
        autoRefreshInterval = setInterval(() => {
            console.log('Auto-refreshing sites data...');
            if (typeof loadSites === 'function') {
                loadSites();
            }
        }, 300000); // 5 –º–∏–Ω—É—Ç
        
        console.log('Auto-refresh started: every 5 minutes');
    }
    
    function stopAutoRefresh() {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('Auto-refresh stopped');
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        console.log('showTelegramSettings function:', typeof window.showTelegramSettings);
        console.log('closeTelegramSettings function:', typeof window.closeTelegramSettings);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        // (—á—Ç–æ–±—ã –±—ã—Ç—å –Ω–∞ 30 —Å–µ–∫—É–Ω–¥ –ø–æ–∑–∂–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞)
        setTimeout(() => {
            startAutoRefresh();
        }, 30000); // 30 —Å–µ–∫—É–Ω–¥
        
        // checkAuth() —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ auth.js
    });
</script>
</body>
</html>